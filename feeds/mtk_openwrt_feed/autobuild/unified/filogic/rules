list_add_after $(hooks autobuild_prepare) platform_change_kernel_config filogic_change_kernel_config
list_add_after $(hooks autobuild_prepare) copy_global_files copy_optee_files
list_add_after $(hooks do_build) download_openwrt_packages airoha_firmware_install

# remove crypto packages to prevent warning caused by package dependency
if [ -z ${internal_build} ]; then
	list_prepend $(hooks autobuild_prepare) remove_crypto_package
fi

if test x"${hqa_set}" == x"yes"; then
	list_add_after $(hooks autobuild_prepare) apply_global_patches apply_hqa_patches
fi

help_add_line "  hqa - Enable HQA test support."

platform_change_openwrt_config() {
	# Enable the following packages for eMMC QVL
	openwrt_config_enable CONFIG_PACKAGE_fio
	openwrt_config_enable CONFIG_PACKAGE_lsblk
	openwrt_config_enable CONFIG_PACKAGE_sfdisk
	openwrt_config_enable CONFIG_PACKAGE_mmc-utils
}

filogic_change_kernel_config() {
	kernel_config_enable CONFIG_EXTRA_FIRMWARE "\"airoha/EthMD32.dm.bin airoha/EthMD32.DSP.bin\""
	kernel_config_enable CONFIG_EXTRA_FIRMWARE_DIR "\"../../linux-firmware-20241110/\""
	kernel_config_enable CONFIG_AIR_EN8811H_PHY
	kernel_config_enable CONFIG_AIR_EN8811H_PHY_DEBUGFS
	kernel_config_enable CONFIG_MT753X_GSW
	kernel_config_enable CONFIG_AN8855_GSW
	kernel_config_disable CONFIG_CPU_FREQ_DEFAULT_GOV_USERSPACE
	kernel_config_enable CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE
	kernel_config_enable CONFIG_LEDS_PWM_MULTICOLOR
	kernel_config_enable CONFIG_NET_DSA_MXL862
	kernel_config_enable CONFIG_NET_DSA_TAG_MXL862
	kernel_config_enable CONFIG_NET_DSA_TAG_MXL862_8021Q
	kernel_config_disable CONFIG_MEDIATEK_NETSYS_V2
	kernel_config_disable CONFIG_MEDIATEK_NETSYS_V3
}

apply_hqa_patches() {
	apply_patches "filogic/${openwrt_branch}/extra-data/hqa_patches" || return 1
}

copy_optee_files() {
	copy_files "${openwrt_root}/../optee/optee_plat_mtk" "package/mtk/optee-mediatek/src/optee_plat_mtk"
	copy_files "${openwrt_root}/../optee/optee_apps" "package/mtk/optee-mediatek/src/optee_apps"
	copy_files "${openwrt_root}/../optee/optee_test_mtk" "package/mtk/optee-mediatek/src/optee_test_mtk"
}

airoha_firmware_install() {
    exec_log "Creating Airoha firmware directory and installing firmware blobs"
    mkdir -p "${openwrt_root}/build_dir/target-aarch64_cortex-a53_musl/linux-mediatek_filogic/linux-6.6.93/drivers/base/firmware_loader/builtin/airoha"
    
    # Copia todos los blobs, ensambladores y objetos necesarios
    cp "${openwrt_root}/feeds/mtk_openwrt_feed/21.02/files/target/linux/mediatek/files-5.4/drivers/base/firmware_loader/builtin/airoha/"* \
       "${openwrt_root}/build_dir/target-aarch64_cortex-a53_musl/linux-mediatek_filogic/linux-6.6.93/drivers/base/firmware_loader/builtin/airoha/"
    
    # Procesar los objetos y ensambladores (EthMD32.dm.bin.gen.o y EthMD32.DSP.bin.gen.o)
    exec_log "Processing EthMD32.dm.bin.gen.o and EthMD32.DSP.bin.gen.o"
    savedcmd_drivers/base/firmware_loader/builtin/airoha/EthMD32.dm.bin.gen.o := aarch64-openwrt-linux-musl-gcc -Wp,-MMD,drivers/base/firmware_loader/builtin/airoha/.EthMD32.dm.bin.gen.o.d -nostdinc -I./arch/arm64/include -I./arch/arm64/include/generated  -I./include -I./arch/arm64/include/uapi -I./arch/arm64/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -D__KERNEL__ -mlittle-endian -DKASAN_SHADOW_SCALE_SHIFT= -fmacro-prefix-map=./= -Werror -D__ASSEMBLY__ -fno-PIE -mabi=lp64 -fno-asynchronous-unwind-tables -fno-unwind-tables -DKASAN_SHADOW_SCALE_SHIFT= -g -c -o drivers/base/firmware_loader/builtin/airoha/EthMD32.dm.bin.gen.o drivers/base/firmware_loader/builtin/airoha/EthMD32.dm.bin.gen.S

    source_drivers/base/firmware_loader/builtin/airoha/EthMD32.dm.bin.gen.o := drivers/base/firmware_loader/builtin/airoha/EthMD32.dm.bin.gen.S
    deps_drivers/base/firmware_loader/builtin/airoha/EthMD32.dm.bin.gen.o := \
      include/linux/compiler-version.h \
      $(wildcard include/config/CC_VERSION_TEXT) \
      include/linux/kconfig.h \
      $(wildcard include/config/CPU_BIG_ENDIAN) \
      $(wildcard include/config/BOOGER) \
      $(wildcard include/config/FOO)
    exec_log "Airoha firmware and command files processed successfully"
}

remove_crypto_package () {
	exec_log "${openwrt_root}/scripts/feeds uninstall crypto-eip pce tops-tool"
}
