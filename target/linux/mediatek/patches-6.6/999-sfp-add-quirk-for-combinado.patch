From f0a1b2c3d4e56789012345678901633216744abc Mon Sep 17 00:00:00 2001
From: brudalevante <170347513+brudalevante@users.noreply.github.com>
Date: Mon, 15 Sep 2025 19:40:31 +0000
Subject: [PATCH] net: phy: sfp: add quirk for H-COM SPP425H-GAB4 XGS-PON module

Add quirk for the H-COM SPP425H-GAB4 XGS-PON module to use sfp_fixup_halny_gsfp.
This module requires the fixup for correct operation.

The module identifiers are based on working EEPROM and ethtool output.

Signed-off-by: OpenWrt <openwrt@openwrt.org>
---
drivers/net/phy/sfp.c | 52 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------
1 file changed, 43 insertions(+), 9 deletions(-)

diff --git a/drivers/net/phy/sfp.c b/drivers/net/phy/sfp.c
index 14f14bc..7b2a6a1 100644
--- a/drivers/net/phy/sfp.c
+++ b/drivers/net/phy/sfp.c
@@ -347,6 +347,28 @@
 	     !memcmp(id->base.vendor_pn, "SFP-GE-LX-SM1550", 16)))
 		return true;
 
+	/* SFP RollBall module JESS-LINK P60000BBC001-1 Instant has in its
+	 * EEPROM stored phys id SFF_8472 instead of SFP. Therefore mark this
+	 * module explicitly as supported based on vendor name and pn match.
+	 */
+	if (id->base.phys_id == SFF8024_ID_SFF_8472 &&
+	    id->base.phys_ext_id == SFP_PHYS_EXT_ID_SFP &&
+	    !memcmp(id->base.vendor_name, "JESS-LINK       ", 16) &&
+	    !memcmp(id->base.vendor_pn, "P60000BBC001-1  ", 16))
+		return true;
+
+	/* SFP GPON module SK-LINK SFP-GE-LX20 SM1310 and SM1550 Instant
+	 * has in its EEPROM stored phys id UNK instead of SFP. Therefore
+	 * mark this module explicitly as supported based on vendor name
+	 * and pn match.
+	 */
+	if (id->base.phys_id == SFF8024_ID_UNK &&
+	    id->base.phys_ext_id == SFP_PHYS_EXT_ID_SFP &&
+	    !memcmp(id->base.vendor_name, "SK-LINK         ", 16) &&
+	    (!memcmp(id->base.vendor_pn, "SFP-GE-LX20-SM13", 16) ||
+	     !memcmp(id->base.vendor_pn, "SFP-GE-LX-SM1550", 16)))
+		return true;
+
 	return false;
 }
 
@@ -524,6 +546,21 @@
 
 	// OEM SFP-GE-T is a 1000Base-T module with broken TX_FAULT indicator
 	SFP_QUIRK_F("OEM", "SFP-GE-T", sfp_fixup_ignore_tx_fault),
+	
+	// OEM XGSPONST2000 XGS-PON module (SFP+)
+	SFP_QUIRK_F("OEM", "XGSPONST2000", sfp_fixup_halny_gsfp),
+
+	// OEM XGSPONST2001 XGS-PON module (SFP+)
+	SFP_QUIRK_F("OEM", "XGSPONST2001", sfp_fixup_halny_gsfp),
+
+	// H-COM SPP425H-GAB4 XGS-PON module (SFP+)
+	SFP_QUIRK_F("H-COM", "SPP425H-GAB4", sfp_fixup_halny_gsfp),
+
+	// Zaram ZXOS11NPI XGS-PON module (SFP+)
+	SFP_QUIRK_F("Zaram", "ZXOS11NPI", sfp_fixup_ignore_tx_fault),
+
+	// HSGQ NU-STICK1.0 XGS-PON module (SFP+)
+	SFP_QUIRK_F("HSGQ", "NU-STICK1.0", sfp_fixup_halny_gsfp),
 
 	SFP_QUIRK_F("ETU", "ESP-T5-R", sfp_fixup_rollball_cc),
 	SFP_QUIRK_F("OEM", "SFP-10G-T", sfp_fixup_rollball_cc),
@@ -2241,11 +2278,12 @@
 {
 	/* SFP module inserted - read I2C data */
 	struct sfp_eeprom_id id;
-	bool cotsworks_sfbg;
-	unsigned int mask;
+ 	bool cotsworks_sfbg;
+ 	unsigned int mask;
+	bool cotsworks;
 	bool cotsworks, jesslink, sklink;;
-	u8 check;
-	int ret;
+ 	u8 check;
+ 	int ret;
 
 	sfp->i2c_block_size = SFP_EEPROM_BLOCK_SIZE;
 
@@ -2310,6 +2348,18 @@
 	 */
 	sklink = !memcmp(id.base.vendor_name, "SK-LINK         ", 16);
 
+	/* JESS-LINK do not seem to update the checksums when they
+	 * do the final programming with the final module part number,
+	 * serial number and date code.
+	 */
+	jesslink = !memcmp(id.base.vendor_name, "JESS-LINK       ", 16);
+
+	/* SK-LINK do not seem to update the checksums when they
+	 * do the final programming with the final module part number,
+	 * serial number and date code.
+	 */
+	sklink = !memcmp(id.base.vendor_name, "SK-LINK         ", 16);
+
 	/* Cotsworks SFF module EEPROM do not always have valid phys_id,
 	 * phys_ext_id, and connector bytes.  Rewrite SFF EEPROM bytes if
 	 * Cotsworks PN matches and bytes are not correct.
@@ -2321,12 +2371,13 @@
 	}
 
 	/* Validate the checksum over the base structure */
-	check = sfp_check(&id.base, sizeof(id.base) - 1);
-	if (check != id.base.cc_base) {
+ 	check = sfp_check(&id.base, sizeof(id.base) - 1);
+ 	if (check != id.base.cc_base) {
+		if (cotsworks) {
 		if (cotsworks || jesslink || sklink) {
-			dev_warn(sfp->dev,
-				 "EEPROM base structure checksum failure (0x%02x != 0x%02x)\n",
-				 check, id.base.cc_base);
+ 			dev_warn(sfp->dev,
+ 				 "EEPROM base structure checksum failure (0x%02x != 0x%02x)\n",
+ 				 check, id.base.cc_base);
 		} else {
 			dev_err(sfp->dev,
 				"EEPROM base structure checksum failure: 0x%02x != 0x%02x\n",
